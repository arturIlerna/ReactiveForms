<div class="container">
  <h2>Sistema de Reserves de Viatges</h2>

  <div class="search-box">
    <label>Cerca ràpida de destinació:</label>
    <input type="text" [formControl]="searchControl" placeholder="Filtra ciutats...">
    
    @if (filteredDestinations.length === 0) {
      <p class="error-msg">No s'han trobat resultats</p>
    }
  </div>

  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
    
    <fieldset>
      <legend>Dades del Client</legend>
      
      <div class="form-group">
        <label>Nom Complet:</label>
        <input type="text" formControlName="fullName">
        
        @if (bookingForm.get('fullName')?.touched && bookingForm.get('fullName')?.invalid) {
          <div class="error-msg">
            Mínim 3 caràcters, només lletres i espais.
          </div>
        }
      </div>

      <div class="form-group">
        <label>DNI/NIE:</label>
        <input type="text" formControlName="dniNie">
      </div>

      <div class="form-group">
        <label>Email:</label>
        <input type="email" formControlName="email">
        
        @if (bookingForm.get('email')?.pending) {
          <div class="info-msg">Comprovant...</div>
        }
        
        @if (bookingForm.get('email')?.errors?.['emailTaken']) {
          <div class="error-msg">L'email ja existeix.</div>
        }
      </div>

      <div class="form-group">
        <label>Telèfon:</label>
        <input type="text" formControlName="phone">
      </div>

      <div class="form-group">
        <label>Data de Naixement:</label>
        <input type="date" formControlName="birthDate">
      </div>
    </fieldset>

    <fieldset>
      <legend>Informació del Viatge</legend>

      <div class="form-group">
        <label>Destinació:</label>
        <select formControlName="destination">
          @for (d of filteredDestinations; track d) {
            <option [value]="d">{{d}}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label>Data de Sortida:</label>
        <input type="date" formControlName="departureDate">
      </div>

      <div class="form-group">
        <label>Data de Retorn:</label>
        <input type="date" formControlName="returnDate">
        
        @if (bookingForm.errors?.['invalidRange']) {
          <div class="error-msg">La tornada ha de ser posterior a la sortida.</div>
        }
      </div>

      <div class="form-group">
        <label>Tipus de Viatge:</label>
        <input type="radio" value="anada" formControlName="tripType"> Només anada
        <input type="radio" value="anada_tornada" formControlName="tripType"> Anada i tornada
      </div>

      <div class="form-group">
        <label>Classe:</label>
        <select formControlName="travelClass">
          <option value="turista">Turista</option>
          <option value="business">Business</option>
          <option value="primera">Primera classe</option>
        </select>
      </div>

      <div class="form-group">
        <label>Nombre de Passatgers (1-10):</label>
        <input type="number" formControlName="passengersCount">
      </div>
    </fieldset>

    @if (additionalPassengers.length > 0) {
      <div formArrayName="additionalPassengers">
        <h3>Dades Passatgers Addicionals</h3>
        
        @for (p of additionalPassengers.controls; track p; let i = $index) {
          <div [formGroupName]="i" class="passenger-card">
            <h4>Passatger {{ i + 2 }}</h4>
            <input type="text" formControlName="nom" placeholder="Nom">
            <input type="number" formControlName="edat" placeholder="Edat">
            <select formControlName="relacio">
              <option value="familia">Familia</option>
              <option value="amic">Amic</option>
              <option value="altre">Altre</option>
            </select>
          </div>
        }
      </div>
    }

    <div class="conditions">
      <input type="checkbox" formControlName="terms"> Accepto termes i condicions (required)
      <br>
      <input type="checkbox" formControlName="newsletter"> Rebre newsletter
    </div>

    <div class="price-display">
      Preu Total: <strong>{{ totalPrice }}€</strong>
    </div>

    <button type="submit" [disabled]="bookingForm.invalid">Submit</button>
  </form>
</div>